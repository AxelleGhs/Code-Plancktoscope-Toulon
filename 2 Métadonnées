#2
#M√©tadonn√©es
#Ce script prend en entr√©e un ou plusieurs fichiers TSV obtenu √† partir d'ecotaxa et rend en sortie un fichier excel avec des m√©tadonn√©es importantes pour les calculs d'abondance (diff√©rents volumes utilis√©s)

library(readr)
library(dplyr)
library(writexl)

# üìÅ √âtape 1 : S√©lection d‚Äôun fichier pour identifier le dossier
message("Veuillez s√©lectionner un fichier TSV quelconque dans le dossier contenant tous les fichiers.")
un_fichier_du_dossier <- file.choose()
dossier_donnees <- dirname(un_fichier_du_dossier)

# üìÑ √âtape 2 : Lister tous les fichiers TSV dans ce dossier
fichiers <- list.files(path = dossier_donnees, pattern = "\\.tsv$", full.names = TRUE)

# üè∑Ô∏è Colonnes d‚Äôint√©r√™t
colonnes_cibles <- c(
  "sample_project",
  "object_date",
  "sample_concentrated_sample_volume",
  "sample_total_volume",
  "sample_dilution_factor",
  "acq_imaged_volume"
)

# üì¶ √âtape 3 : Initialiser une liste pour stocker les m√©tadonn√©es
liste_metadonnees <- list()

# üîÅ √âtape 4 : Boucle sur chaque fichier
for (fichier in fichiers) {
  # Lire seulement la premi√®re ligne de donn√©es
  donnees <- read_tsv(fichier, n_max = 1, show_col_types = FALSE)
  
  # V√©rifier si toutes les colonnes n√©cessaires sont pr√©sentes
  if (!all(colonnes_cibles %in% colnames(donnees))) {
    warning(paste("‚ö†Ô∏è Colonnes manquantes dans :", basename(fichier)))
    next
  }
  
  # Extraire les colonnes + ajouter calculs
  meta <- donnees %>%
    select(all_of(colonnes_cibles)) %>%
    mutate(
      Prelevement_total_volume_m3 = sample_total_volume / 1000,
      Prelevement_concentrated_volume_m3 = sample_concentrated_sample_volume / 1e6,
      acq_imaged_volume_m3 = acq_imaged_volume / 1e6
    )
  
  # Ajouter √† la liste
  liste_metadonnees[[basename(fichier)]] <- meta
}

# üßæ √âtape 5 : Fusionner toutes les lignes
donnees_finales <- bind_rows(liste_metadonnees)

# üíæ √âtape 6 : Exporter vers Excel
fichier_sortie <- file.path(dossier_donnees, "M√©tadonn√©es.xlsx")
write_xlsx(donnees_finales, path = fichier_sortie)

message("‚úÖ Fichier 'M√©tadonn√©es.xlsx' cr√©√© avec succ√®s dans : ", dossier_donnees)
