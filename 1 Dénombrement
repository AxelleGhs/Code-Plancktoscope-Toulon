#1
#D√©nombrement
#Premier script de la s√©rie pour obtenir les graphgiques suite √† une manipulation de planktoscope + ecotaxa
#Ce script prend en entr√©e le fichier TSV obtenu √† partir d'ecotaxa et rend en sortie un fichier Excel contenant pour chaque Tripliquat le nombre d'individus par taxon (vivant et non-vivant)
#IMPORTANT : ne pas run le script en une seule fois mais, au contraire, run ligne apr√®s ligne car √† la 48√®me ligne il est demand√© de donn√© le nom du fichier
#Le nom du fichier doit √™tre PR ou GR ou PortToulon + _ + JJMMAAAA : exemple : PR_24042025


# Packages n√©cessaires
library(readr)
library(writexl)
library(dplyr)
library(tidyr)
library(stringr)

# Lire le fichier TSV
file_path <- file.choose()  # ou sp√©cifier un chemin
df <- read_tsv(file_path, show_col_types = FALSE)

# üîç Filtrer uniquement les annotations "validated"
df_validated <- df %>%
  filter(object_annotation_status == "validated")

# Nettoyage et extraction des champs utiles
df_clean <- df_validated %>%
  mutate(
    Taxonomie = sub("<.*", "", object_annotation_category),
    Triplicat = as.integer(str_extract(acq_id, "(?<=triplicat_)[0-9]+(?=_sur)"))
  ) %>%
  select(Taxonomie, Triplicat)

# Comptage par taxonomie et triplicat
df_counts <- df_clean %>%
  group_by(Taxonomie, Triplicat) %>%
  summarise(Nombre = n(), .groups = "drop") %>%
  pivot_wider(
    names_from = Triplicat,
    values_from = Nombre,
    names_prefix = "Triplicat_",
    values_fill = list(Nombre = 0)
  )

# Ajouter les triplicats manquants (1 √† 3)
for (i in 1:3) {
  col_name <- paste0("Triplicat_", i)
  if (!(col_name %in% colnames(df_counts))) {
    df_counts[[col_name]] <- 0
  }
}

# R√©organiser les colonnes
df_counts <- df_counts %>%
  select(Taxonomie, Triplicat_1, Triplicat_2, Triplicat_3)

# üîΩ Demander le nom du fichier de sortie
output_file <- readline(prompt = "Entrez le nom du fichier de sortie (avec .xlsx) : ")

# V√©rifier l'extension
if (!grepl("\\.xlsx$", output_file)) {
  output_file <- paste0(output_file, ".xlsx")
}

# Exporter le r√©sultat
write_xlsx(df_counts, output_file)

# üîç R√©sum√©
cat("\nR√©sum√© de l'analyse :\n")
cat("----------------------\n")
cat("Nombre total de taxons diff√©rents :", nrow(df_counts), "\n")
cat("Nombre total d'observations (valid√©es) :", sum(df_counts$Triplicat_1 + df_counts$Triplicat_2 + df_counts$Triplicat_3), "\n")
cat("Fichier export√© :", output_file, "\n")

